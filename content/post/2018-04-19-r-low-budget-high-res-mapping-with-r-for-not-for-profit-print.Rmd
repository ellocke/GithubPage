---
title: '[R] Low-Budget High-Res Mapping with R for Not-for-Profit Print'
author: fubits
date: '2018-04-19'
slug: r-low-budget-high-res-mapping-with-r-for-not-for-profit-print
output:
  html_document:
    toc: true
categories:
  - Rstats
  - Mapping
tags:
  - Map
  - CC0
  - Publishing
  - Print
lastmod: '2018-05-20T17:11:53+02:00'
keywords: []
description: ''
comment: no
toc: no
autoCollapseToc: no
postMetaInFooter: no
hiddenFromHomePage: no
contentCopyright: no
reward: no
mathjax: no
mathjaxEnableSingleDollar: no
mathjaxEnableAutoNumber: no
hideHeaderAndFooter: no
flowchartDiagrams:
  enable: no
  options: ''
sequenceDiagrams:
  enable: no
  options: ''
---

![*(Spoiler: final version of the map)*](/img/map_final_v20_96dpi.png "#MyFirstMap"){width=100%}
*Presented as a Lightning Talk at [CODE/GEO/GRAPHIC, Berlin, 19 April 2018](http://code-geo-graphic.com/)*

(This is my first ever "how-to", so please be so kind and point me to any errors and feel free to help me improve my code and approach!)

## 1. Setting
Once upon a time (and long before I learned about the [tidyverse](https://twitter.com/hashtag/Tidyverse?src=hash) and %>%), a colleague from a not-for-profit org asked for help with a map for a book. The conversation may or may not have sounded like that:

>*We need a map for a book but we don't have a budget.*\
>*And we need the map to be based on license-free material (no CC, no Leaflet, no OSM).*\
>*And it will be printed in black & white.*\
>*And we need some states to be grouped in four regions in total.*\
>*And you know that the editors work with MS Word...*


## 2. Workflow
"Simple" 3-step-process (actually 4):

* find Public Domain / CC-0 geodata (vector & raster)
* render the geodata as SVG
* polish SVG in Illustrator / **Affinity** Designer et al.
* (fit SVG to PDF page)

How hard could that be, right?

![(c) Monkey User](/img/monkeyuser_everytime.png "#Everytime"){width=100%}


### 2.1 Packages
```{r message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(ggrepel)
library(maps)
library(ggthemes)
library(rasterVis)
library(dplyr)
library(maptools)
library(sp)
# library(rnaturalearth) # <- source for geodata, but pkg masks some needed fun() from other packages, so rather address methods by rnaturalearth::fun() 
```


### 2.2 Geodata: World Map Data from Natural Earth
>*"Natural Earth is a public domain map dataset available at 1:10m, 1:50m, and 1:110 million scales. Featuring tightly integrated vector and raster data, with Natural Earth you can make a variety of visually pleasing, well-crafted maps with cartography or GIS software."* [(Link to Natural Earth)](http://www.naturalearthdata.com/)


#### Base Map (Admin-0 Level)
Let's first import the geodata and check the basemap.

```{r echo=TRUE}
world <- rnaturalearth::countries110
plot(world)
```

Ugh, not so pretty, right? But you have to start somewhere...

**Spoiler: Some Geo-Objects – which were only mentioned later on – are missing at Admin-0 level.**


#### (-> Fetch Non-Admin-0 Elements (Guam & Singapore))
```{r}
# countries10 <- rnaturalearth::ne_download(scale = 10,
#                                           type = 'countries',
#                                           category = 'cultural')
# save(countries10, file = "GIS_NPO_Data/countries10.rda")
load("../../data/GIS_NPO_Data/countries10.rda")
```


#### Where's Guam?
```{r}
# First, let's search for Guam:
# "Guam" %in% rnaturalearth::countries110$SOVEREIGNT #> FALSE, not "souvereign"
# Let's search below Admin-0 level within rnaturalearth::ne_states() 
# world.sub <- rnaturalearth::ne_states()
# head(world.sub, 1) # > either $name or $geounit
# "Guam" %in% world.sub$geonunit #> TRUE (vs. $name <- might be cruical for some)
Guam <- rnaturalearth::ne_states(geounit = 'guam')
Guam$category <- "D" # 4 regions A-D, as requested by colleague
plot(Guam)
```


#### Where's Singapore?
```{r}
#> "Singapore" %in% rnaturalearth::countries110$SOVEREIGNT is FALSE, so apparently,
# it is a souvereign state, but as a city-state to granular for the 1:110m data.
# Let's search in the 1:10m data

Singapore <- countries10[countries10$SOVEREIGNT == 'Singapore',]
# "Singapore" %in% world.sub$geonunit #> is also TRUE, while
# "Guam" %in% countries10$SOVEREIGNT is FALSE
# Caution: Scope of data from countries110 & countries10 might differ!
Singapore$category <- "C"
plot(Singapore)
```


### 2.3 Assemble the Regions

#### China
```{r}
asia.china <- world[world$sovereignt == 'China',]
asia.china$category <- "A"
plot(asia.china)
```


#### Eastern Asia (== $subregion minus China & Mongolia )
```{r}
asia.east <- world[world$subregion == 'Eastern Asia' &
                     world$sovereignt != 'Mongolia' &
                     world$sovereignt != 'China',]
asia.east$category <- "D"
plot(asia.east)
```


#### South-Eastern Asia
```{r}
asia.seast <- world[world$subregion == 'South-Eastern Asia',]
asia.seast$category <- "C"
plot(asia.seast)
```


#### Central and South Asia (plus Russia & Mongolia)
```{r}
asia.censouth <- world[world$region_wb == 'South Asia' |
                         world$subregion == 'Central Asia' |
                         world$sovereignt == 'Mongolia' |
                         world$sovereignt == 'Russia',]
asia.censouth$category <- "B"
plot(asia.censouth)
```

**Why Russia, why?** (cf. [Thread](https://twitter.com/HalukaMB/status/974674444970020867) & [Solution](https://twitter.com/HalukaMB/status/982306518522527744) by [Haluka](https://twitter.com/HalukaMB)
)

#### Solution: Set left BBOX-Border to clip Russia's overlapping tail
```{r}
leftBorder <- 25
asia.censouth@bbox[1] <- leftBorder
plot(asia.censouth)
```


#### Consolidate the Core
```{r}
asia.core <-  spRbind(
                spRbind(
                  spRbind(asia.china, asia.east),
                     asia.seast),
                        asia.censouth) # or just %>% next time :)
asia.core@bbox[1] <- leftBorder
plot(asia.core)
```


#### Consolidate the Rest
##### (Preview)
```{r}
asia.rest <- world[world$region_un == "Asia" &
                     world$sovereignt != 'China' | 
                     world$region_un == "Oceania" | 
                     world$region_un == "Africa" |
                     world$region_un == "Europe",]
asia.rest@bbox[1] <- leftBorder
plot(asia.rest)
```


#### Remove the Core
```{r}
asia.rest <- subset.data.frame(asia.rest,
                              !(asia.rest$sovereignt %in% asia.core$sovereignt))
asia.rest@bbox[1] <- leftBorder
plot(asia.rest)
```


### 2.4 Convert Spatial Dataframe to a tidy dataframe
>(this was done before [geom_sf / ggsf](http://ggplot2.tidyverse.org/reference/ggsf.html) where introduced to [ggplot2](http://ggplot2.tidyverse.org/index.html). There might exist a more elegant solution right now, esp. with ggplot.)


#### Tidy the Vector Data
```{r message=FALSE}
asia.core@data$id <- row.names(asia.core@data)
Singapore@data$id <- row.names(Singapore@data)
Guam@data$id <- row.names(Guam@data)
asia.main <- broom::tidy(asia.core)
asia.main <- dplyr::left_join(asia.main, asia.core@data, by = 'id')
head(asia.main, 1)
```



#### Create centered Country Labels
```{r echo=TRUE}
centroids.df <- as.data.frame(coordinates(asia.core)) # returns centered points
centroids.df$sovereignt <- asia.core$sovereignt # add country names

# I had to include Guam and Singapore only after I already rendered the core
# map, so this is my rather awkward work-around to include them subsequently
sing.centroids.df <- as.data.frame(coordinates(Singapore))
sing.centroids.df$sovereignt <- Singapore$SOVEREIGNT
centroids.df <- rbind(centroids.df, sing.centroids.df)
Guam.centroids.df <- as.data.frame(coordinates(Guam))
Guam.centroids.df$sovereignt <- Guam$name
centroids.df <- rbind(centroids.df, Guam.centroids.df)

# rename the colnames
names(centroids.df) <- c("Long", "Lat", "Name")
head(centroids.df, 1)
```


### 2.5 Relief Raster

#### Get the Relief Raster File
```{r echo=TRUE, cache=TRUE}
# Either:
# physics <- rnaturalearth::ne_download(scale = 50, category = 'raster',
#                                       type = 'NE2_50M_SR_W', load = TRUE)

# OR:
# Download from: http://www.naturalearthdata.com/downloads/50m-raster-data/
# Here: NE2, shaded relief, water: http://www.naturalearthdata.com/http//www.naturalearthdata.com/download/50m/raster/NE2_50M_SR_W.zip
relief.world <- raster("../../data/NE2_50M_SR_W.tif") # 170 MB file
plot(relief.world)
```


#### (If needed: reduce Raster Resolution)
```{r include=TRUE, echo=TRUE, cache=TRUE}
# reduce resolution by 50% (I didn't do it since we want high-res for print)
# s2 <- aggregate(s, fact = 2)
# plot(s2)
```


#### Crop the Raster File
```{r, cache=TRUE}
# deprecated:
# manually select the box for the region with mouse pointer -> quick but bad!!!
# s <- raster::select(relief)
# plot(s)

# OR:
# Crop around dataframe
# relief.sub <- crop(relief, extent(asia.rest))

# OR
# Clean & easy: just define the extend of the box
box <- extent(25, 155, -25, 60) # how to calculate ratio (i.e. 1: 1,48)?
relief.boxcrop <- crop(relief.world, box)
plot(relief.boxcrop)
```


#### Raster for the Core Regions
```{r, cache=TRUE}
# Mask everything apart from the core regions terrain
# relief.land <- raster::mask(relief.boxcrop, asia.core) # mask {E} != asia.core
# save(relief.land, file = "GIS_NPO_Data/relief_land.rda")
load("../../data/GIS_NPO_Data/relief_land.rda")
plot(relief.land)
```


#### Convert Core Raster to SPDF to DF
```{r}
# Raster to SPDF
relief.land_spdf <- as(relief.land, "SpatialPixelsDataFrame")
# SPDF to DF (for ggplot)
relief.land_df <- as.data.frame(relief.land_spdf) %>% 
  rename(value = `NE2_50M_SR_W`)
head(relief.land_df, 1)
```


#### Raster for the Rest (Water & Terrain)
```{r, cache=TRUE}
# relief.meer <- raster::mask(relief.boxcrop, asia.core, inverse=TRUE) # maskiert alles == asia.core
# save(relief.meer, file = "GIS_NPO_Data/relief_meer.rda")
load("../../data/GIS_NPO_Data/relief_meer.rda")
plot(relief.meer)
```


#### Convert 2nd Raster to DF
```{r}
relief.meer_spdf <- as(relief.meer, "SpatialPixelsDataFrame")
relief.meer_df <- as.data.frame(relief.meer_spdf) %>% 
  rename(value = `NE2_50M_SR_W`)
head(relief.meer_df, 1)
```


## 3. Results
### Preview with Default Colors
```{r message=FALSE}
ggplot() +
  # Polygons for the 4 regions
  geom_polygon(data = fortify(asia.main), alpha = 0.5,
               aes(x = long, y = lat, group = group,
                   fill = asia.main$category),
               color = "white", size = 1) +
  geom_polygon(data = fortify(asia.rest), alpha = 0.5,
               aes(x = long, y = lat, group = group),
               fill = "grey89", color = "white", size = 1) +
  geom_polygon(data = fortify(Singapore), alpha = 0.5,
               aes(x = long, y = lat, group = group),
               color = "white", fill = "red", size = 1) +
  geom_polygon(data = fortify(Guam), alpha = 0.5,
               aes(x = long, y = lat, group = group),
               color = "white", fill = "red", size = 1) +
  # normalise coordinates and crop canvas
  coord_equal(ratio = 1, xlim = c(25, 149), ylim = c(54.9, -25)) + # cropped
  theme_map() +
  theme(legend.position = "none") +
  # repel =  no overlapping between labels
  geom_text_repel(data = fortify(centroids.df),
                aes(label = Name, size = 12, x = Long, y = Lat),
                segment.colour = NA)
```

### Map without raster/terrain
```{r message=FALSE}
# Better approach:  Setting dimensions for {r}-snippet according to requirements
# for print would be much better for serialisation and polishing in Illustrator et al.
map <- ggplot() +
 # raster
  # geom_raster(data = relief.land_df, aes(x = x, y = y, alpha = value)) +
  # geom_raster(data = relief.meer_df, aes(x = x, y = y, alpha = value)) +
  # scale_alpha(name = "", range = c(0.4, 0), guide = F) + #  "alpha hack"
  geom_polygon(data = fortify(asia.rest), alpha = 0.5,
               aes(x = long, y = lat, group = group),
               fill = "grey89", color = "white", size = 1) +
  geom_polygon(data = fortify(asia.main), alpha = 0.5,
               aes(x = long, y = lat, group = group, fill = asia.main$category),
               color = "white", size = 1) +
  geom_polygon(data = fortify(Singapore), alpha = 0.5,
               aes(x = long, y = lat, group = group),
               color = "white", fill = "red", size = 1) +
  geom_polygon(data = fortify(Guam), alpha = 0.5,
               aes(x = long, y = lat, group = group),
               color = "white", fill = "red", size = 1) +
  # scale_fill_grey(start = 0.2, end = 0.8) + 
  scale_fill_manual(values = c("#f7f7f7", "#cccccc", "#969696", "#525252")) + 
  # 4-class greya from colorbrewer.org: #f7f7f7 #cccccc #969696 #525252
  coord_equal(ratio = 1, xlim = c(25,149), ylim = c(54.9, -25)) + # cropped
  theme_map() +
  theme(legend.position = "none") +
  geom_text_repel(data = fortify(centroids.df),
                  aes(label = Name, size = 12, x = Long, y = Lat),
                  segment.colour = NA)
plot(map)
```


### Map with full raster (core and rest)
(~3 min rendering time with Intel i7 7500 / 16 GB / SSD)

```{r message=FALSE, cache=TRUE}
map <- ggplot() +
 # raster
  geom_raster(data = relief.land_df, aes(x = x, y = y, alpha = value)) +
  geom_raster(data = relief.meer_df, aes(x = x, y = y, alpha = value)) +
  scale_alpha(name = "", range = c(0.4, 0), guide = F) + # "alpha hack"
  geom_polygon(data = fortify(asia.rest), alpha = 0.5,
               aes(x = long, y = lat, group = group),
               fill = "grey89", color = "white", size = 1) +
  geom_polygon(data = fortify(asia.main), alpha = 0.5,
               aes(x = long, y = lat, group = group,
                   fill = asia.main$category),
               color = "white", size = 1) +
  geom_polygon(data = fortify(Singapore), alpha = 0.5,
               aes(x = long, y = lat, group = group),
               color = "white", fill = "red", size = 1) +
  geom_polygon(data = fortify(Guam), alpha = 0.5,
               aes(x = long, y = lat, group = group),
               color = "white", fill = "red", size = 1) +
  # scale_fill_grey(start = 0.2, end = 0.8) + 
  scale_fill_manual(values = c("#f7f7f7", "#cccccc", "#969696", "#525252")) + 
  # 4-class grey from colorbrewer.org: #f7f7f7 #cccccc #969696 #525252
  coord_equal(ratio = 1, xlim = c(25,149), ylim = c(54.9, -25)) + # cropped
  theme_map() +
  theme(legend.position = "none") +
  geom_text_repel(data = fortify(centroids.df),
                  aes(label = Name, size = 12, x = Long, y = Lat),
                  segment.colour = NA)
plot(map)
```

Not perfect, but sufficient for post-processing the output SVG with a vector processing app. One issue I wasn't able to dissolve, is the different interpretations of the left border set to 25. While the raster definitively is cropped to 25°, the polygons extend beyond that. I'm quite sure that this is because of [Kaliningrad](https://en.wikipedia.org/wiki/Kaliningrad), so I guess it should be possible to ID the **exclave** by "String %in% $var" and exclude it from the dataframe. I might test that later.

Since the map was going to be printed in BW, I decided to provide at least some relieve with regards to the overloaded color scheme. Remember: While ColorBrewer recommends a max of 3 color levels for BW, this map has 4 shades of grey for the 4 core regions, 1 color for water (and borders), and another grey shade for countries which are not part of the core region. Add black for the labels and we end up with 7 colors. So leaving water areas and the rest of the world without relief, while highlighting the core regions by underlying them with a relief kind of works here. Don't @ me :)

### Final processing of output SVG in Affinity Photo / Designer
![*"Processing the SVG in Affinity"*](/img/map_affinity.jpg "Processing the SVG"){width=100%}


Basically, I just scaled the SVG to 300 dpi, changed the fonts and slightly readjusted the alpha levels of the regions.
That's it. We're done here.
(PS: We're not, since someone has to blog about it and maybe even hold it as a lighting talk at a cool workshop)

## 4. Lessons Learned

* ([Map Projections, anyone?](https://xkcd.com/977/))

* Print != "JPEG". We need high-res data and have to check for artifacts (i.e. small islands which might be rendered with 1px and then be printed as "corns")

* Demand **precise** specifics:

    
    Full list of ALL features
  
    Print **dimensions** for the map (absoulte in cm/inch or ratio)
  
    Publication/**layout** dimensions (page size, font size, orientation/layout, keep in mind 300dpi)
    
    Check whether there's some **Corporate Design** Manual (i.e. for fonts & colors)
  
    Will there be a **caption**? -> If yes, leave some space for it.
    
    For printing on white paper: do we need a black **border** around the map?
    
    **Probably best way to start with is to ask for a *sketch*!**

* Show-case your first **prototype** as early as possible -> early error detection

* Let your "client" double-check geopolitical **pitfalls** (think Crimea!)

* Black & white printing: For the sake of **inclusion** and quality: do not use more than 3 shades of grey (plus white)

* For colorized printing: Think about those 10% with **reduced red/green vision** (-> consult [ColorBrewer2](http://colorbrewer2.org))

* Explicitly agree on **credits** for your work (and actually, try to agree on a CC-licensing)

* Encountered some problems and found a way out? --> **Share your knowledge**: Blog / GitHub / Present / Discuss / Revise

* Send the final version as a pre-rendered **robust** PDF (but still include the SVG).

**Thanks for reading!**

![*"Fun with ~~flags~~ **maps**"*](/img/sheldon_maps.jpg "Fun with ~~flags~~ **maps**"){width=100%}


## 5. (Some) Sources
These links are some of the key sources, which helped me to get started with mapping in R:

* [Ilya Kashnitsky's Blog](https://ikashnitsky.github.io/), whose posts were the reason I started to map with R on my own

* [Timo Grossenbacher](https://timogrossenbacher.ch/2016/12/beautiful-thematic-maps-with-ggplot2-only/), who documented how to include raster file in ggplot
    
* [Lisa C. Rost](https://academy.datawrapper.de/article/117-color-palette-for-your-map), Design Guru at DataWrapper
    
* [Team Color Brewer 2.0](http://colorbrewer2.org), tool for generating color palettes for all kinds of use
