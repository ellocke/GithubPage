---
title: '[R] GIS like It''s 2019: Visualising Berlin Crime Data'
author: Ilja / fubits
date: '2019-01-29'
slug: r-gis-like-it-s-2019-visualising-berlin-crime-data
categories:
  - GIS
  - Mapping
  - Open Data
tags:
  - sf
  - raster
  - mapview
  - mapedit
  - osmdata
output:
  blogdown::html_page:
    number_sections: yes
    toc: yes
lastmod: '2019-01-29T21:21:12+01:00'
description: ''
abstract: ''
draft: TRUE
thumbnail: /img/thumbs/conference_tweets_pt2.jpg
rmdlink: yes
keywords: []
comment: no
autoCollapseToc: no
postMetaInFooter: no
hiddenFromHomePage: no
mathjax: no
mathjaxEnableSingleDollar: no
mathjaxEnableAutoNumber: no
---

To be fair, my R "career" actually only gained traction when I was asked to create a low-budget hi-res [map for print]() by a colleague almost one and a half years ago. This particular use case gave me enough insights into the awesomeness of the Rstats / FOSS-minded community, the holistic potential of R re: all things `data`, and in particular the [#GIStribe](https://www.twitter.com/#GIStribe){target="_blank"}'s continuous efforts to improve spatial processing with R.

Recently, I did a similar but far more extensive freelance gig and discovered so many really helpful / effective / efficient / cool packages, methods and tools that I decided to write another GIS/mapping post. It's simply time to give something back to the community (and to create a useful reference entry for my future self).

In this post, we're going to take a tour through several highly versatile spatial packages for R. As a use case, we're going to visualise aggregated crime data (district-level; yearly) for my hometown Berlin, Germany.

This post is not about basic geo-computation / GIS / cartography concepts. For this, there already are plenty of excellent up-to-date resources such as Lovelace/Novosad 2018, Jesse Adler's solid series on R for Digital Humanities, or https://statnmap.com/2018-07-14-introduction-to-mapping-with-sf-and-co/

This post is more like my own glossary for all the magical things / hacks.

In order to focus on the specific packages and functions, I'm going to load `tidyverse` only. Everything else will be called by `package::function()'. However, you might want to install the following packages:

    rnaturalearth
    sf
    raster
    osmdata
    mapview
    mapedit
    
Not strictly GIS, but still highy recommended for any workflow:

    here
    

```{r message=FALSE}
library(tidyverse)
library(sf)
```

# Basic Workflows

## Basemap Area: Three ways

First of all, we'll need to read in the crime data and decide on the extent of the basemap. Since this is a recurrent task but with varying parameters, I''m offering three different approaches based 

    a) on the bounding box (BBOX) of a spatial object (i.e. a Federal state)
    b) on the bounding box of spatial data (i.e. the geocoded crime data)
    c) a hand-drawn rectangle turned into a BBOX
    
### Bounding Box: Object-based

First, we need our spatial object of reference. I prefer to work with Open Access / Public Domain data, so let's fetch some vector data from the Natural Earth project - but as Simple Features instead of Esri's propiertary (and not tidyverse-friendly) shapefile format. 

> For your use case, consult the vignette for `rnaturaleath::ne_download()` and the [Natural Earth website](https://www.naturalearthdata.com/downloads/){target="_blank"}

```{r eval=FALSE}
substates10 <- rnaturalearth::ne_download(scale = 10, type = "admin_1_states_provinces", category = "cultural", returnclass = "sf")
saveRDS(substates10, file = str_c(here::here("data", "GIS_Berlin_Crime", "/"), "substates10.rds"))
```

```{r echo=FALSE}
substates10 <- readRDS(file = str_c(here::here("data", "GIS_Berlin_Crime"), "/", "substates10.rds"))
```

```{r}
berlin_sf <- substates10 %>% filter(name == "Berlin")
```


Now, we'll use the amazing Simple Feature's package to fetch Berlin's spatial bounding box.

```{r}
berlin_bbox <- sf::st_bbox(berlin_sf)
```

So... wanna have a quick glipmse at Berlin's bounding box? Here's all that it takes with the `mapview` package:

```{r}
berlin_bbox %>% mapview::mapview()
```


> Caveat: In order to make this work with `blogdown`, we need to save this chunk's output as a `htmlwidget`.

And since `mapview()` is cool, we clan plot inspect our Berlin polygon and the BBOX. For this we're going to convert the BBOX object into a regular simple feature object with `sf::st_as_sfc` on the fly:

```{r}
mapview::mapview(list(sf::st_as_sfc(berlin_bbox), berlin_sf))
```


Since the coordinates in the `bbox` are stored as named numeric vector (c(xmin, ymin, xmax, ymax)), we can easily expand the `bbox` by providing another vector of length = 4 and see if the extent is better immediatly:

```{r}
{berlin_bbox + c(-0.1, -0.1, 0.1, 0.1)} %>%
  mapview::mapview()
```

That seems generous enough. So let's keep this box.

```{r}
berlin_bbox <- berlin_bbox + c(-0.1, -0.1, 0.1, 0.1)
```


### BBOX from data

Another approach to get a reasonable boundig box to display and work with, is to calculate the bbox based on your geodata.

Berlin-based *Tagespiegel* did

```{r eval=FALSE}
berlin_bike <- sf::st_read("https://github.com/tagesspiegel/radmesser/blob/master/opendata/detailnetz_ueberholvorgaenge.geo.json?raw=true")
saveRDS(berlin_bike, file = str_c(here::here("data", "GIS_Berlin_Crime", "/"), "berlin_bike.rds"))
```


```{r echo=FALSE, cache=TRUE}
berlin_bike <- readRDS(file = str_c(here::here("data", "GIS_Berlin_Crime"), "/", "berlin_bike.rds"))
```

```{r}
mapview::mapview(berlin_bike)
```


```{r}
berlin_bike_bbox <- sf::st_bbox(berlin_bike)
```

```{r}
mapview::mapview(list(st_as_sfc(berlin_bike_bbox), berlin_bike))
```

### Hand-drawn BBOX with `mapedit`

```{r eval=FALSE}
(berlin_custom <- mapview::mapview(berlin_sf) %>% mapedit::drawFeatures())
saveRDS(berlin_custom, file = str_c(here::here("data", "GIS_Berlin_Crime", "/"), "berlin_custom.rds"))
```

```{r echo=FALSE}
berlin_custom <- readRDS(file = str_c(here::here("data", "GIS_Berlin_Crime"), "/", "berlin_custom.rds"))
```

```{r}
berlin_custom_bbox <- sf::st_bbox(berlin_custom)
```

```{r}
mapview::mapview(list(sf::st_as_sfc(berlin_custom_bbox), berlin_bike))
```

## Basemap Contents

### Quick: Natural Earth
```{r}

```

### Custom: OSM with `osmdata`