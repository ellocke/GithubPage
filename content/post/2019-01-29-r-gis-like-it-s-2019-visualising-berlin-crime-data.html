---
title: '[R] GIS like It''s 2019: Visualising Berlin Crime Data'
author: Ilja / fubits
date: '2019-01-29'
slug: r-gis-like-it-s-2019-visualising-berlin-crime-data
categories:
  - GIS
  - Mapping
  - Open Data
tags:
  - sf
  - raster
  - mapview
  - mapedit
  - osmdata
output:
  blogdown::html_page:
    number_sections: yes
    toc: yes
lastmod: '2019-01-29T21:21:12+01:00'
description: ''
abstract: ''
draft: FALSE
thumbnail: /img/thumbs/conference_tweets_pt2.jpg
rmdlink: yes
keywords: []
comment: no
autoCollapseToc: no
postMetaInFooter: no
hiddenFromHomePage: no
mathjax: no
mathjaxEnableSingleDollar: no
mathjaxEnableAutoNumber: no
---


<div id="TOC">
<ul>
<li><a href="#a-bit-of-a-context"><span class="toc-section-number">1</span> A Bit of a Context</a></li>
<li><a href="#basic-workflows---vector"><span class="toc-section-number">2</span> Basic Workflows - Vector</a><ul>
<li><a href="#basemap-bounding-box-three-approaches"><span class="toc-section-number">2.1</span> Basemap Bounding Box: Three Approaches</a><ul>
<li><a href="#bounding-box-object-based"><span class="toc-section-number">2.1.1</span> Bounding Box: Object-based</a></li>
<li><a href="#bbox-from-data"><span class="toc-section-number">2.1.2</span> BBOX from data</a></li>
<li><a href="#hand-drawn-bbox-with-mapedit"><span class="toc-section-number">2.1.3</span> Hand-drawn BBOX with <code>mapedit</code></a></li>
</ul></li>
<li><a href="#basemap-contents"><span class="toc-section-number">2.2</span> Basemap Contents</a><ul>
<li><a href="#quick-natural-earth"><span class="toc-section-number">2.2.1</span> Quick: Natural Earth</a></li>
<li><a href="#custom-osm-with-osmdata"><span class="toc-section-number">2.2.2</span> Custom: OSM with <code>osmdata</code></a></li>
</ul></li>
</ul></li>
</ul>
</div>

<div id="a-bit-of-a-context" class="section level1">
<h1><span class="header-section-number">1</span> A Bit of a Context</h1>
<blockquote>
<p>If you’re just here for the code / hacks, feel free to skip this intro and jump directly to the <a href="#basic-workflows---vector">hands-on part</a>.</p>
</blockquote>
<p>To be precise, my R “career” only started to gain traction when I was asked to create a <a href="/r-low-budget-high-res-mapping-with-r-for-not-for-profit-print/">low-budget CC0 print map</a> by a colleague almost one and a half years ago. This particular use case gave me enough of an impression of the awesomeness of the Rstats / FOSS-minded community, the holistic potential of R re: all things <code>data</code>, and in particular the <a href="https://twitter.com/hashtag/gistribe" target="_blank">#GIStribe</a>’s continuous efforts to make spatial processing with R accessable to everyone. What I did <strong>not</strong> know back then (among maaaaany other things) was that there was already existing a dual system of Base R and Tidy / Tidy-fied R - even for spatial…</p>
<p><a href="https://milesmcbain.xyz/r2vr3-shading-meshes-in-webvr/" target="_blank"><img src="/img/GIS_workflow/r2vr_McBain.jpg" alt="Miles McBain’s r2vr demo" /></a></p>
<p>If you consider that <a href="https://mdsumner.github.io/2017/01/10/spatial-r-2017.html" target="_blank">this post</a> by <a href="https://mdsumner.github.io/2017/01/10/spatial-r-2017.html" target="_blank">@mdsumner</a> was written already two years ago, and R users potentially have been able to do stuff such as to <em>“colour a WebVR mesh by shading using a raster layer”</em> (cf. screenshot above; <a href="https://milesmcbain.xyz/r2vr3-shading-meshes-in-webvr/" target="_blank">McBain 2018</a>) with the <code>r2vr</code> package <strong>in R</strong> for more than half a year now, I think this quote by Michael D. Sumner just perfectly sums up what’s the status quo and the potential of “spatial / GIS with R”:</p>
<blockquote>
<p>“GIS itself needs what we can already do in R, it’s not a target we are aspring to[,] it’s the other way around.” (<a href="https://mdsumner.github.io/2017/01/10/spatial-r-2017.html" target="_blank">Sumner 2017</a>)</p>
</blockquote>
<p>I mean, this <code>rayshader</code> output (pictured below; click on the image to see the full GIF in action) by the package’s developer <a href="https://twitter.com/tylermorganwall" target="_blank">Tyler Morgan-Wall</a> is not just a proof-of-concept. It’s out there on CRAN, it’s one technique already available for everyone with just a basic understanding of R and/or geocomputation.</p>
<p><a href="https://www.rayshader.com/" target="_blank"><img src="/img/GIS_workflow/rayshader.jpg" alt="click on this link to see the full GIF in action" /></a></p>
<p>Also, have a look at what Michael D. Sumner has been working on with the <a href="https://hypertidy.github.io/quadmesh/" target="_blank">quadmesh package</a>, which will allow us - among other things - to take <code>raster</code> to another level. Same for <a href="https://www.r-spatial.org/r/2017/11/23/stars1.html" target="_blank">Edzer Pebesma’s<code>stars</code> package</a> with regards to its potential for tidy spatiotemporal data.</p>
<p>In short, GIS with R is efficient, effective, performative and shiny and complex enough</p>
<hr />
<p>Recently, I did another but far more extensive freelance gig involving custom mapping and real-world geodata, and thereby discovered so many really helpful / effective / efficient / cool packages, methods, tools and workflows that I decided to write another GIS/mapping post. It’s simply time to give something back to the community (and to create a useful reference entry for my future self).</p>
<p>In this post, we’re going to take a tour through several versatile spatial packages for R. As a use case, we’re going to visualise <del>aggregated crime data (district-level; yearly)</del> for my hometown Berlin, Germany.</p>
<p>This post is not about basic geocomputation / GIS / cartography concepts. For this, there already are plenty of excellent up-to-date resources such as Lovelace/Novosad 2018, Jesse Adler’s solid series on R for Digital Humanities, or <a href="https://statnmap.com/2018-07-14-introduction-to-mapping-with-sf-and-co/" class="uri">https://statnmap.com/2018-07-14-introduction-to-mapping-with-sf-and-co/</a>.</p>
<p>If there’s a single really helpful thing to have present in mind for now, it’s this basic representation of GIS’ data layers which exists out there in several forms:</p>
<div class="figure">
<img src="/img/GIS_workflow/gis_layers.gif" alt="Source: National Coastal Data Development Centre (NCDDC), National Oceanic and Atmospheric Administration (NOAA), USA" />
<p class="caption">Source: National Coastal Data Development Centre (NCDDC), National Oceanic and Atmospheric Administration (NOAA), USA</p>
</div>
<p>This post is more like my own glossary for all the magical things / hacks.</p>
<pre class="r"><code>library(tidyverse)
library(sf)
library(mapview)
library(mapedit)
library(rnaturalearth)
library(osmdata)
# library(raster) # I prefer to use raster::fun() since raster::select() masks dplyr::select()</code></pre>
</div>
<div id="basic-workflows---vector" class="section level1">
<h1><span class="header-section-number">2</span> Basic Workflows - Vector</h1>
<p>Let’s assume that we want to make some kind of a map, be it because we actually need a map (i.e. for a <a href="https://www.amazon.de/Krieg-vor-Haustür-Europas-Nachbarschaft/dp/3801205487/ref=sr_1_1?ie=UTF8&amp;qid=1549128023" target="_blank">great book on European foreign policy</a>), or maybe just to give some spatial data some kind of a cognitive canvas. As geodata tends to take up non-trivial amounts of resources (bandwith, memory, CPU), it could be usuful to focus on only a particular geographic extent. This is where I learned to love the concept of a bounding box (BBOX). Instead of literally downloading the whole world (thereby straining someone elses bandwith / server capacity) and then running costly query/filter operations, we can easily define bounds first.</p>
<p>If you’re spatially literate and therefore easily can spot whether you need Lat/Lon or Lon/Lat, or what projection / CRS your favourite BBOX-providing workflow offers, you probably can skip this and just define your BBOX manually with something like <code>bbox &lt;- c(xmin, ymin, xmax, ymax)</code>. I tend to struggle with this (even when using web tools such as <a href="http://bboxfinder.com" target="_blank">http://bboxfinder.com</a>), because I either mix up Lat/lon or underestimate the spatial extent of my geodata or whatever. This is why I think that these three approaches below might be helpful to others, too.</p>
<div id="basemap-bounding-box-three-approaches" class="section level2">
<h2><span class="header-section-number">2.1</span> Basemap Bounding Box: Three Approaches</h2>
<p>So first of all we want to decide on the extent of the basemap. Since this is a recurrent task but with varying parameters, I’m offering three different approaches, based on</p>
<ul>
<li><ol style="list-style-type: lower-alpha">
<li>the bounding box (BBOX) of a spatial object (i.e. Admin 1 level Federal state|s)</li>
</ol></li>
<li><ol start="2" style="list-style-type: lower-alpha">
<li>the bounding box of spatial data (i.e. the geocoded cyling data)</li>
</ol></li>
<li><ol start="3" style="list-style-type: lower-alpha">
<li>a hand-drawn rectangle turned into a BBOX</li>
</ol></li>
</ul>
<div id="bounding-box-object-based" class="section level3">
<h3><span class="header-section-number">2.1.1</span> Bounding Box: Object-based</h3>
<p>Here, we start with our spatial object of reference. I prefer to work with Open Access / Public Domain data (and not Google Maps / Bing et al.), so let’s fetch some vector data from the Natural Earth project - but as <code>class = Simple Feature</code> instead of Esri’s propiertary (and less tidyverse-friendly) <code>Shapefile</code> format.</p>
<blockquote>
<p>For your use case, consult the vignette for <code>rnaturaleath::ne_download()</code> and the <a href="https://www.naturalearthdata.com/downloads/" target="_blank">Natural Earth website</a>.
For the sake of resource efficiency I also recomend to download the data once and then to store it locally with <code>save</code>/<code>saveRDS</code> for future use. As I work a lot with Natural Earth data, I have mounted a network folder <code>D:/GIS/</code> with all the raster and vector data I’ve downloaded so far.</p>
</blockquote>
<pre class="r"><code>substates10 &lt;- rnaturalearth::ne_download(scale = 10, type = &quot;admin_1_states_provinces&quot;, category = &quot;cultural&quot;, returnclass = &quot;sf&quot;)
saveRDS(substates10, file = str_c(here::here(&quot;data&quot;, &quot;GIS_Berlin_Crime&quot;, &quot;/&quot;), &quot;substates10.rds&quot;))</code></pre>
<pre class="r"><code>berlin_sf &lt;- substates10 %&gt;% filter(name == &quot;Berlin&quot;)</code></pre>
<p>Now, we’ll use the amazing <code>sf</code> package to fetch Berlin’s bounding box.</p>
<pre class="r"><code>berlin_bbox &lt;- sf::st_bbox(berlin_sf)</code></pre>
<p>So… wanna have a quick glipmse at Berlin’s bounding box? Here’s all that it takes with the <code>mapview</code> package:</p>
<pre class="r"><code>berlin_bbox %&gt;% mapview::mapview()</code></pre>
<blockquote>
<p>Caveat: To keep memory and CPU load low for everyone browsing this post, I mostly will display the output of interactive widgets as <code>.jpg</code>.</p>
</blockquote>
<blockquote>
<p>If you want to set the “CartoDB Dark Matter” basemap as your default (or any other of the <a href="http://leaflet-extras.github.io/leaflet-providers/preview/" target="_blank">themes supported by Leaflet</a> ), you might want to add this setting to your <code>.Rprofile</code>:</p>
</blockquote>
<pre><code>mapviewOptions(basemaps = c(&quot;CartoDB.DarkMatter&quot;, &quot;CartoDB.Positron&quot;, &quot;Esri.WorldImagery&quot;, &quot;OpenStreetMap&quot;, &quot;OpenTopoMap&quot;))</code></pre>
<p>And since <code>mapview()</code> is cool, we clan plot and inspect our Berlin polygon and the BBOX at the same time. For this we’re going to convert the BBOX object into a regular simple feature object with <code>sf::st_as_sfc</code> on the fly:</p>
<pre class="r"><code>mapview::mapview(list(sf::st_as_sfc(berlin_bbox), berlin_sf))</code></pre>
<p><img src="/img/GIS_workflow/mapview_bbox.jpg" /></p>
<p>This box would probably be too narrow for further editing, so it would be cool if we could simply increae the BBOX’s extent. Since the coordinates in the <code>bbox</code> are stored as a numeric vector <code>c(xmin, ymin, xmax, ymax)</code>, we can easily expand the <code>bbox</code> by providing another vector of length = 4 and see if the extent is better on the fly:</p>
<pre class="r"><code>(berlin_bbox + c(-0.1, -0.1, 0.1, 0.1)) %&gt;%
  # sf::st_as_sfc() %&gt;% 
  mapview::mapview()</code></pre>
<p><img src="/img/GIS_workflow/mapview_bbox_plus.jpg" /></p>
<p>That seems generous enough. So let’s preserve this box for later.</p>
<pre class="r"><code>berlin_bbox &lt;- berlin_bbox + c(-0.1, -0.1, 0.1, 0.1)</code></pre>
</div>
<div id="bbox-from-data" class="section level3">
<h3><span class="header-section-number">2.1.2</span> BBOX from data</h3>
<p>Another approach to get a reasonable boundig box to display and work with, is to calculate the bbox based on your geodata.</p>
<p>As mentioned above, I’m going to use the freshly released cycling data from the Berlin-based <em>Tagespiegel</em> DDJ / Innovation Lab. The data has been collected as part of the sensor-based #radmesser project, where Lab leader <a href="https://twitter.com/plateauton" target="&quot;_blank">Hendrik Lehmann</a>’s team of journalists and developers equiped 100 (!) cyclists with close-range sensors to measure the distance of passing-by cars and trucks on Berlin’s roads, and to demostrate the at-risk status of cyclists in Germany’s capital.</p>
<blockquote>
<p>Make sure to check out the award-winning <a href="https://interaktiv.tagesspiegel.de/radmesser/" target="_blank">project’s website</a> and the <a href="https://github.com/tagesspiegel/radmesser/tree/master/opendata" target="_blank">project’s repo</a>.</p>
</blockquote>
<p>It’s probably worth the remark that getting the data into R is as simple as <code>sf::st_read(URL)</code>…</p>
<pre class="r"><code>berlin_bike &lt;- sf::st_read(&quot;https://github.com/tagesspiegel/radmesser/blob/master/opendata/detailnetz_ueberholvorgaenge.geo.json?raw=true&quot;)</code></pre>
<pre class="r"><code>mapview::mapview(berlin_bike)</code></pre>
<blockquote>
<p>Pics test</p>
</blockquote>
<p><img src="/img/GIS_workflow/bikedata.jpg" /></p>
<pre class="r"><code>berlin_bike_bbox &lt;- sf::st_bbox(berlin_bike)</code></pre>
<pre class="r"><code>mapview::mapview(list(st_as_sfc(berlin_bike_bbox), berlin_bike))</code></pre>
</div>
<div id="hand-drawn-bbox-with-mapedit" class="section level3">
<h3><span class="header-section-number">2.1.3</span> Hand-drawn BBOX with <code>mapedit</code></h3>
<pre class="r"><code>(berlin_custom &lt;- mapview::mapview(berlin_sf) %&gt;% mapedit::drawFeatures())</code></pre>
<p><img src="/img/GIS_workflow/mapedit.jpg" /></p>
<pre class="r"><code>berlin_custom_bbox &lt;- sf::st_bbox(berlin_custom)</code></pre>
<pre class="r"><code>mapview::mapview(list(sf::st_as_sfc(berlin_custom_bbox), berlin_bike))</code></pre>
</div>
</div>
<div id="basemap-contents" class="section level2">
<h2><span class="header-section-number">2.2</span> Basemap Contents</h2>
<div id="quick-natural-earth" class="section level3">
<h3><span class="header-section-number">2.2.1</span> Quick: Natural Earth</h3>
</div>
<div id="custom-osm-with-osmdata" class="section level3">
<h3><span class="header-section-number">2.2.2</span> Custom: OSM with <code>osmdata</code></h3>
</div>
</div>
</div>
